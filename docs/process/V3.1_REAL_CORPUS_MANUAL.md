# Resonance V3.1 Real Corpus Processing & Review Manual

## Overview

Resonance V3.1 introduces real-world corpus processing and human review capabilities. This manual covers the complete workflow for processing music libraries and reviewing canonicalness decisions.

## Key Components

### üéØ **Agent Stability Improvements**
- **Problem**: LLM context overflow from multi-MB artifacts
- **Solution**: Strategy A - chunked JSON assets + on-demand fetching
- **Result**: HTML interface reduced from 3.1MB ‚Üí 22KB

### üîç **Real Corpus Processing**
- **Input**: `tests/real_corpus/metadata.json` (extracted filesystem metadata)
- **Processing**: Full Resonance workflow (scan ‚Üí resolve ‚Üí plan ‚Üí apply)
- **Output**: Deterministic results in `expected_*.json` files

### üñ•Ô∏è **Review Interface**
- **3-column layout**: Directory Tree | Contents | Detail Inspector
- **Features**: Search, filter, manual browsing, state indicators
- **Data**: Fetched on-demand from chunked JSON assets

---

## Prerequisites Check

**Do you have corpus data?**
```bash
ls -lh tests/real_corpus/metadata.json
```

- ‚úÖ **If YES** ‚Üí Skip to Quick Start (corpus already extracted)
- ‚ùå **If NO** ‚Üí Do Phase 1 first (extract from real music library)

---

## Quick Start (If Corpus Data Exists)

If `tests/real_corpus/metadata.json` already exists, run this complete workflow:

```bash
# 1. Process the real corpus (generate results)
export RUN_REAL_CORPUS=1
python3 -m pytest tests/integration/test_real_world_corpus.py -v

# 2. Generate review bundle
python3 scripts/generate_review_bundle.py

# 3. Generate HTML interface
python3 scripts/generate_review_interface.py

# 4. Serve and review
python3 -m http.server -d dist 8080
# Open: http://localhost:8080/real_corpus_review.html
```

---

## Detailed Workflow

### Phase 1: Corpus Extraction (Only if needed)

**When to do this**: If `tests/real_corpus/metadata.json` doesn't exist yet.

**Purpose**: Extract filesystem metadata from a real music library to create test data.

```bash
# Extract filesystem metadata (creates tests/real_corpus/metadata.json)
./scripts/extract_real_corpus.sh /path/to/music/library

# Validate extraction worked
python3 scripts/corpus_summary.py
```

**Output**: `tests/real_corpus/metadata.json` (~1.3MB with 5079 audio files)
**Why**: Creates deterministic test data from real music libraries for processing.

### Phase 2: Corpus Processing

Run Resonance on the extracted corpus:

```bash
# Set environment variables
export RUN_REAL_CORPUS=1

# Run the full deterministic workflow
python3 -m pytest tests/integration/test_real_world_corpus.py::test_real_world_corpus_deterministic_workflow -v

# Alternative: Use convenience script
python3 regen_real_corpus.py
```

**What happens**:
- Creates fake filesystem from metadata
- Scans 410+ directories
- Resolves using MusicBrainz/Discogs providers
- Plans and applies organization
- Generates expected results

**Outputs**:
- `tests/real_corpus/expected_state.json` - Directory states
- `tests/real_corpus/expected_layout.json` - File organization
- `tests/real_corpus/expected_tags.json` - Metadata tags

### Phase 3: Review Bundle Generation

Aggregate results for human review:

```bash
# Generate comprehensive review bundle
python3 scripts/generate_review_bundle.py
```

**Input**: All `tests/real_corpus/*.json` files
**Output**: `review_bundle.json` (~2.9MB with 410 directories)

**Contents**:
- Corpus summary and metadata
- Directory tree with states
- Track details and mappings
- Input file hashes for auditability

### Phase 4: HTML Interface Generation

Create the review interface (Strategy A - no large embedding):

```bash
# Generate chunked HTML interface
python3 scripts/generate_review_interface.py
```

**Strategy A Implementation**:
- `dist/index.json` (72KB) - Directory tree index
- `dist/dir/<id>.json` (412 files √ó ~5KB) - Per-directory chunks
- `dist/real_corpus_review.html` (22KB) - Interface with fetch logic
- `dist/manifest.json` (38KB) - SHA256 hashes for audit

### Phase 5: Manual Review

Serve and interact with the interface:

```bash
# Start local server
python3 -m http.server -d dist 8080

# Open in browser
# http://localhost:8080/real_corpus_review.html
```

---

## Interface Features

### Header Bar
- **Title**: "Resonance Real Corpus Review"
- **Stats**: File count, directory count, max depth
- **Search**: Filter by path, artist, album substring
- **Filters**: State filter (APPLIED/JAILED/PENDING), track mapping filter

### Directory Tree (Left Panel)
- **Collapsible**: Expand/collapse directory nodes
- **Indicators**: Track counts, state badges (APPLIED ‚ö°, JAILED üö´, PENDING ‚è≥)
- **Selection**: Click to load directory contents

### Directory Contents (Middle Panel)
- **Breadcrumb**: Clickable path navigation
- **Track List**: Filename, size, duration, mapping status
- **Sorting**: By filename, size, duration
- **Badges**: "mapped" (green) or "missing tags" (red)

### Detail Inspector (Right Panel)
- **Track Details**: Original path, expected tags table
- **Directory Context**: State, track count, total size
- **Tag Display**: Key-value table with provenance

---

## Commands Reference

### Corpus Processing
```bash
# Extract metadata from music library
./scripts/extract_real_corpus.sh /path/to/music

# Process corpus and generate results
export RUN_REAL_CORPUS=1
python3 -m pytest tests/integration/test_real_world_corpus.py -v

# Regenerate expected snapshots
export RUN_REAL_CORPUS=1 REGEN_REAL_CORPUS=1
python3 -m pytest tests/integration/test_real_world_corpus.py -v

# Convenience script for regeneration
python3 regen_real_corpus.py
```

### Interface Generation
```bash
# Generate review bundle
python3 scripts/generate_review_bundle.py

# Generate HTML interface (Strategy A)
python3 scripts/generate_review_interface.py

# Validate without opening large files
python3 scripts/corpus_summary.py
```

### Review Interface
```bash
# Serve interface locally
python3 -m http.server -d dist 8080

# Access interface
# http://localhost:8080/real_corpus_review.html

# View manifest/audit info
# http://localhost:8080/manifest.json
```

---

## Agent Stability Safeguards

### Hard Rules (MUST follow)
- ‚ùå **Never** paste/load multi-MB JSON/HTML into LLM context
- ‚ùå **Never** open entire large files in editor pane
- ‚úÖ **Only** inspect via: `ls -lh`, `head -n`, `jq` queries, small Python snippets
- ‚úÖ **Generate** small summaries (<200KB) instead of reading full files

### Safe Inspection Methods
```bash
# File sizes
ls -lh tests/real_corpus/*.json

# Schema inspection
head -n 20 tests/real_corpus/metadata.json

# Count directories
python3 -c "import json; print(len(json.load(open('review_bundle.json'))['directory_tree']))"

# Summary without loading full files
python3 scripts/corpus_summary.py
```

---

## File Structure

```
resonance/
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ generate_review_bundle.py      # Creates review_bundle.json
‚îÇ   ‚îú‚îÄ‚îÄ generate_review_interface.py   # Creates HTML interface (Strategy A)
‚îÇ   ‚îî‚îÄ‚îÄ corpus_summary.py              # Safe summary (<200KB output)
‚îú‚îÄ‚îÄ tests/real_corpus/
‚îÇ   ‚îú‚îÄ‚îÄ metadata.json                  # Extracted filesystem data (1.3MB)
‚îÇ   ‚îú‚îÄ‚îÄ expected_state.json           # Directory states
‚îÇ   ‚îú‚îÄ‚îÄ expected_layout.json          # File organization
‚îÇ   ‚îú‚îÄ‚îÄ expected_tags.json            # Expected metadata
‚îÇ   ‚îî‚îÄ‚îÄ decisions.json                # Scripted prompt decisions
‚îú‚îÄ‚îÄ dist/                             # Generated interface assets
‚îÇ   ‚îú‚îÄ‚îÄ real_corpus_review.html       # Main interface (22KB)
‚îÇ   ‚îú‚îÄ‚îÄ index.json                    # Directory tree index (72KB)
‚îÇ   ‚îú‚îÄ‚îÄ dir/*.json                    # Per-directory chunks (412 √ó ~5KB)
‚îÇ   ‚îî‚îÄ‚îÄ manifest.json                 # Audit hashes (38KB)
‚îî‚îÄ‚îÄ review_bundle.json               # Comprehensive review data (2.9MB)
```

---

## Troubleshooting

### Interface Not Loading
```bash
# Check if dist/ exists and has files
ls -la dist/

# Regenerate interface
python3 scripts/generate_review_interface.py

# Check for JavaScript errors in browser console
```

### Corpus Processing Fails
```bash
# Check metadata exists
ls -lh tests/real_corpus/metadata.json

# Run with verbose output
export RUN_REAL_CORPUS=1
python3 -m pytest tests/integration/test_real_world_corpus.py -v -s

# Check decisions file
cat tests/real_corpus/decisions.json
```

### Agent Context Overflow
```bash
# Use safe summary instead of loading files
python3 scripts/corpus_summary.py

# Inspect file sizes only
ls -lh tests/real_corpus/*.json dist/*.json

# Use jq for small queries
jq '.corpus_summary' review_bundle.json
```

---

## V3.1 Release Notes

### ‚úÖ **Completed Features**
- Real corpus processing with deterministic results
- Human review interface with 3-column layout
- Agent stability fixes (99% size reduction)
- Audit trails with SHA256 hashes
- Manual browsing for canonicalness review
- Search and filtering capabilities

### üîÑ **Workflow Status**
- **Corpus Extraction**: ‚úÖ Automated via scripts
- **Processing Pipeline**: ‚úÖ Full Resonance workflow
- **Review Interface**: ‚úÖ Strategy A implementation
- **Stability**: ‚úÖ Zero context overflow risk
- **Auditability**: ‚úÖ Complete hash chains

### üéØ **Key Achievements**
- **410 directories** processed deterministically
- **HTML size**: 3.1MB ‚Üí 22KB (99% reduction)
- **Agent safety**: No multi-MB files in context
- **Manual review**: Full directory tree navigation
- **Performance**: On-demand loading, no lag

---

## Next Steps

1. **Run the corpus** using the commands above
2. **Review results** in the HTML interface
3. **Validate decisions** for each directory's canonicalness
4. **Approve corpus** for V3.1 release gate

The interface enables manual validation of Resonance's automated decisions, ensuring high-quality canonicalness assessment for the entire music library.
