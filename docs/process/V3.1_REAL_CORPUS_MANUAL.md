# Resonance V3.1 Real Corpus Processing & Review Manual

## Overview

Resonance V3.1 introduces real-world corpus processing and human review capabilities. This manual covers the complete workflow for processing music libraries and reviewing canonicalness decisions.

## Key Components

### üéØ **Agent Stability Improvements**
- **Problem**: LLM context overflow from multi-MB artifacts
- **Solution**: Strategy A - chunked JSON assets + on-demand fetching
- **Result**: HTML interface reduced from 3.1MB ‚Üí 22KB

### üîç **Real Corpus Processing**
- **Input**: `tests/real_corpus/metadata.json` (extracted filesystem metadata)
- **Processing**: Full Resonance workflow (scan ‚Üí resolve ‚Üí plan ‚Üí apply)
- **Output**: Deterministic results in `expected_*.json` files

### üñ•Ô∏è **Review Interface**
- **3-column layout**: Directory Tree | Contents | Detail Inspector
- **Features**: Search, filter, manual browsing, state indicators
- **Data**: Fetched on-demand from chunked JSON assets

---

## Core Principle

There are **three layers** in the corpus workflow, but **two review decisions**:

1. **Extract Input Metadata (rare)**: Capture filesystem data from real disk
2. **Run Resonance Pipeline (frequent)**: Process metadata into deterministic outputs
3. **Review Results (human)**: Classify canonicalness decisions

### üîí **Full-Corpus Policy**

**Non-negotiable rule**: Real corpus runs are always full-corpus runs.

- ‚ùå **No batch caps**: No `MAX_BATCHES`, no `batches[:5]`, no partial execution
- ‚ùå **No subset knobs**: Environment variables like `REAL_CORPUS_MAX_BATCHES` cause hard failure
- ‚úÖ **Always complete**: If `RUN_REAL_CORPUS=1`, process ALL directories in metadata.json
- ‚úÖ **CI separation**: Use `tests/fixture_corpus/` for fast CI validation

This ensures "PENDING" states are meaningful (actual unresolved classifications) rather than "never processed".

---

## Decision Table

| Operation | What it means | When to run | Command | Mutates State |
|-----------|---------------|-------------|---------|---------------|
| **A. Extract input corpus metadata** | Capture filesystem metadata into `tests/real_corpus/metadata.json` | Real library changed; want new capture | `make corpus-extract` | ‚úÖ Yes (input) |
| **B. Run Resonance decisions** | **FULL-CORPUS**: Process ALL directories in metadata into expected outputs + review artifacts | Rules/providers changed; release prep | `make corpus-decide` | ‚úÖ Yes (expected + dist) |
| **C. Review / classify** | Human inspection of outputs | Validate canonicalness; approve V3.1 | `make corpus-review` | ‚ùå No |

Everything else is implementation detail and must be handled by one-command automation.

---

## Layer A: Extract Input Corpus Metadata (Rare)

**Choose this if:**
- The real music library changed
- You want to capture a new dataset from disk
- You're intentionally refreshing the input data

**Command:**
```bash
make corpus-extract
```

**What it does (atomic):**
- Extracts filesystem metadata from configured library path
- Writes `tests/real_corpus/metadata.json` (~1.3MB)
- Produces validation summary via `scripts/corpus_summary.py`
- Never runs Resonance or rebuilds artifacts

---

## Layer B: Run Resonance Pipeline (Frequent)

**Choose this if:**
- Canonicalization rules changed
- Providers or resolvers changed
- You want new expected snapshots
- Preparing a release gate
- Regression testing

**Command:**
```bash
make corpus-decide
```

**What it does (atomic):**
- Runs deterministic Resonance pipeline on existing metadata
- Regenerates expected_state.json, expected_layout.json, expected_tags.json
- Rebuilds review_bundle.json and HTML interface
- Produces audit hashes
- **Fails fast** if metadata.json is missing (no implicit extraction)

---

## Layer C: Review/Classify Results (Human)

**Choose this if:**
- You want to review canonicalness decisions
- You want to validate directory organization
- You're approving or rejecting V3.1 output

**Command:**
```bash
make corpus-review
```

**What it does:**
- Serves review interface locally
- Loads directory data on demand
- Enables browsing, filtering, and inspection
- No files embedded, no large assets loaded eagerly
- Purely observational (no writes)

---

## Interface Features

### Header Bar
- **Title**: "Resonance Real Corpus Review"
- **Stats**: File count, directory count, max depth
- **Search**: Filter by path, artist, album substring
- **Filters**: State filter (APPLIED ‚ö°, JAILED üö´, PENDING ‚è≥), track mapping filter

### Directory Tree (Left Panel)
- **Collapsible**: Expand/collapse directory nodes
- **Indicators**: Track counts, state badges (APPLIED ‚ö°, JAILED üö´, PENDING ‚è≥)
- **Selection**: Click to load directory contents

### Directory Contents (Middle Panel)
- **Breadcrumb**: Clickable path navigation
- **Track List**: Filename, size, duration, mapping status
- **Sorting**: By filename, size, duration
- **Badges**: "mapped" (green) or "missing tags" (red)

### Detail Inspector (Right Panel)
- **Track Details**: Original path, expected tags table
- **Directory Context**: State, track count, total size
- **Tag Display**: Key-value table with provenance

---

## Commands Reference

### Corpus Processing
```bash
# Extract metadata from music library
make corpus-extract

# Process ALL directories in corpus (full-corpus, no batch limits)
make corpus-decide

# Alternative: Direct pytest commands (advanced users)
export RUN_REAL_CORPUS=1 REGEN_REAL_CORPUS=1
python3 -m pytest tests/integration/test_real_world_corpus.py::test_real_world_corpus_deterministic_workflow -v --tb=short

# Legacy convenience script
python3 regen_real_corpus.py
```

### Interface Generation
```bash
# Generate review bundle
python3 scripts/generate_review_bundle.py

# Generate HTML interface (Strategy A)
python3 scripts/generate_review_interface.py

# Validate without opening large files
python3 scripts/corpus_summary.py
```

### Review Interface
```bash
# Serve interface locally
python3 -m http.server -d dist 8080

# Access interface
# http://localhost:8080/real_corpus_review.html

# View manifest/audit info
# http://localhost:8080/manifest.json
```

---

## Agent Stability Safeguards

### Hard Rules (MUST follow)
- ‚ùå **Never** paste/load multi-MB JSON/HTML into LLM context
- ‚ùå **Never** open entire large files in editor pane
- ‚úÖ **Only** inspect via: `ls -lh`, `head -n`, `jq` queries, small Python snippets
- ‚úÖ **Generate** small summaries (<200KB) instead of reading full files

### Safe Inspection Methods
```bash
# File sizes
ls -lh tests/real_corpus/*.json

# Schema inspection
head -n 20 tests/real_corpus/metadata.json

# Count directories
python3 -c "import json; print(len(json.load(open('review_bundle.json'))['directory_tree']))"

# Summary without loading full files
python3 scripts/corpus_summary.py
```

---

## File Structure

```
resonance/
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ generate_review_bundle.py      # Creates review_bundle.json
‚îÇ   ‚îú‚îÄ‚îÄ generate_review_interface.py   # Creates HTML interface (Strategy A)
‚îÇ   ‚îî‚îÄ‚îÄ corpus_summary.py              # Safe summary (<200KB output)
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ real_corpus/                   # Full real corpus (slow, authoritative)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ metadata.json              # Extracted filesystem data (1.3MB)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ expected_state.json        # Directory states
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ expected_layout.json       # File organization
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ expected_tags.json         # Expected metadata
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ decisions.json             # Scripted prompt decisions
‚îÇ   ‚îî‚îÄ‚îÄ fixture_corpus/               # CI fixture corpus (fast, committed)
‚îÇ       ‚îú‚îÄ‚îÄ metadata.json              # Minimal test data (12KB)
‚îÇ       ‚îú‚îÄ‚îÄ expected_state.json        # Expected states
‚îÇ       ‚îú‚îÄ‚îÄ expected_layout.json       # Expected layout
‚îÇ       ‚îî‚îÄ‚îÄ expected_tags.json         # Expected tags
‚îú‚îÄ‚îÄ dist/                             # Generated interface assets
‚îÇ   ‚îú‚îÄ‚îÄ real_corpus_review.html       # Main interface (22KB)
‚îÇ   ‚îú‚îÄ‚îÄ index.json                    # Directory tree index (285KB)
‚îÇ   ‚îú‚îÄ‚îÄ dir/*.json                    # Per-directory chunks (20 √ó ~5KB)
‚îÇ   ‚îî‚îÄ‚îÄ manifest.json                 # Audit hashes (38KB)
‚îî‚îÄ‚îÄ review_bundle.json               # Comprehensive review data (2.9MB)
```

---

## Troubleshooting

### Interface Not Loading
```bash
# Check if dist/ exists and has files
ls -la dist/

# Regenerate interface
python3 scripts/generate_review_interface.py

# Check for JavaScript errors in browser console
```

### Corpus Processing Fails
```bash
# Check metadata exists
ls -lh tests/real_corpus/metadata.json

# Run with verbose output
export RUN_REAL_CORPUS=1
python3 -m pytest tests/integration/test_real_world_corpus.py -v -s

# Check decisions file
cat tests/real_corpus/decisions.json
```

### Agent Context Overflow
```bash
# Use safe summary instead of loading files
python3 scripts/corpus_summary.py

# Inspect file sizes only
ls -lh tests/real_corpus/*.json dist/*.json

# Use jq for small queries
jq '.corpus_summary' review_bundle.json
```

---

## V3.1 Release Notes

### ‚úÖ **Completed Features**
- Real corpus processing with deterministic results
- Human review interface with 3-column layout
- Agent stability fixes (99% size reduction)
- Audit trails with SHA256 hashes
- Manual browsing for canonicalness review
- Search and filtering capabilities

### üîÑ **Workflow Status**
- **Corpus Extraction**: ‚úÖ Automated via scripts
- **Processing Pipeline**: ‚úÖ Full Resonance workflow
- **Review Interface**: ‚úÖ Strategy A implementation
- **Stability**: ‚úÖ Zero context overflow risk
- **Auditability**: ‚úÖ Complete hash chains

### üéØ **Key Achievements**
- **20 directories** processed deterministically (full-corpus policy)
- **HTML size**: 3.1MB ‚Üí 22KB (99% reduction)
- **Agent safety**: No multi-MB files in context
- **Manual review**: Full directory tree navigation
- **Performance**: On-demand loading, no lag

---

## Next Steps

1. **Extract corpus metadata** (if needed): `make corpus-extract`
2. **Run full corpus processing**: `make corpus-decide`
3. **Review results** in the HTML interface: `make corpus-review`
4. **Validate decisions** for each directory's canonicalness
5. **Approve corpus** for V3.1 release gate

The interface enables manual validation of Resonance's automated decisions, ensuring high-quality canonicalness assessment for the entire music library.
