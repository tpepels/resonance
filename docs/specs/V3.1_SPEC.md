# V3.1 Specification — Real-World Corpus Validation

## Version Info
- **Version**: V3.1 (Closed)
- **Closure Date**: 2025-12-23
- **Audit**: AUDIT_V3.1.md (PASS)
- **Predecessor**: V3
- **Successor**: V4

---

## Overview

V3.1 extends V3's curated-case validation to **real-world corpus validation**. While V3 proves "Resonance works on curated examples", V3.1 proves **"Resonance works on your actual music library"**.

**Key Innovation**: Deterministic testing against real music library structures without requiring file copying or network access.

---

## 1. Core Architecture

### Real-World Corpus Concept

**Problem Solved**: V3 validates against small, curated test cases. Real music libraries have:
- Legacy tagging patterns
- Deep directory structures
- Mixed audio formats
- Large scale (1000s of albums)
- Real provider API responses

**Solution**: Extract metadata from real libraries, create deterministic test harnesses that replay real filesystem structures and provider responses.

### Corpus Extraction Pipeline

#### Metadata Extraction
- **Input**: Real music library path (e.g., `~/Music`)
- **Output**: `metadata.json` with directory structure and file metadata
- **Safety**: Read-only operations, explicit path blocking
- **Scope**: Configurable via manifest files
- **Determinism**: Same library → same metadata

#### Filesystem Faker
- **Purpose**: Serve extracted metadata as live filesystem API
- **Implementation**: Monkey-patches `os.path`, `os.listdir`, `os.stat`
- **Fallback**: Real filesystem for non-corpus paths
- **Transparency**: Existing Resonance code runs unchanged

### Test Harness Architecture

#### Offline-First Design
- **Default Mode**: No network calls during test execution
- **Cache Integration**: Provider responses served from deterministic cache
- **Determinism**: Same metadata → same test results
- **Safety**: Never modifies real library

#### Scripted Decision System
- **Problem**: Real libraries contain PROBABLE/UNSURE identifications requiring user input
- **Solution**: `decisions.json` maps `dir_id` → scripted decision
- **Decisions**: `"AUTO"` (automatic), `"JAIL"` (skip), or `"provider:release_id"` (force)
- **Fallback**: Graceful skipping for missing decisions

---

## 2. API Specifications

### Corpus Extraction API

#### Extraction Script
```bash
./scripts/extract_real_corpus.sh <library_path>
```

**Parameters**:
- `library_path`: Path to music library (must be whitelisted)
- `MANIFEST.txt`: Optional filter for specific directories

**Outputs**:
- `tests/real_corpus/metadata.json`: Extracted metadata
- Safety checks and progress reporting

#### Metadata Format
```json
{
  "_comment": "Extracted filesystem metadata",
  "_extraction_time": "2025-12-23T18:30:00+01:00",
  "_source_path": "/home/user/music",
  "_total_files": 1500,
  "_audio_files": 1450,
  "files": [
    {
      "path": "Artist/Album/track01.flac",
      "size": 45000000,
      "mtime": 1672531200,
      "permissions": "644",
      "is_audio": true,
      "audio_info": {"duration": 180, "bitrate": 1411000}
    }
  ]
}
```

### Test Harness API

#### Corpus Test Execution
```bash
RUN_REAL_CORPUS=1 pytest tests/integration/test_real_world_corpus.py
```

**Environment Variables**:
- `RUN_REAL_CORPUS=1`: Enable corpus tests (opt-in)
- `REGEN_REAL_CORPUS=1`: Regenerate snapshots

#### Filesystem Faker API
```python
from tests.integration._filesystem_faker import FilesystemFaker, FakerContext

faker = FilesystemFaker("tests/real_corpus/metadata.json")
with FakerContext(faker):
    # Existing Resonance code works unchanged
    # os.listdir(), os.path.exists(), etc. serve from metadata
    pass
```

#### Scripted Decisions API
```json
{
  "decisions": {
    "dir_hash_1": "AUTO",
    "dir_hash_2": "JAIL",
    "dir_hash_3": "musicbrainz:release_id_123"
  }
}
```

### Snapshot Format

#### State Snapshot (`expected_state.json`)
```json
{
  "_comment": "Expected terminal states",
  "summary": {
    "total_directories": 150,
    "applied": 145,
    "jailed": 3,
    "failed": 2
  },
  "states": {
    "dir_id_1": {
      "pinned_provider": "musicbrainz",
      "pinned_release_id": "release_123",
      "state": "APPLIED"
    }
  }
}
```

#### Layout Snapshot (`expected_layout.json`)
```json
{
  "_comment": "Expected file layout",
  "files": [
    "Artist/Album/01 - Track One.flac",
    "Artist/Album/02 - Track Two.flac"
  ]
}
```

#### Tags Snapshot (`expected_tags.json`)
```json
{
  "tracks": [
    {
      "path": "Artist/Album/01 - Track One.flac",
      "tags": {
        "TITLE": "Track One",
        "ARTIST": "Artist",
        "ALBUM": "Album",
        "resonance_provider": "musicbrainz",
        "resonance_release_id": "release_123"
      }
    }
  ]
}
```

---

## 3. Behavior Specifications

### Corpus Extraction Behavior

#### Safety Checks
- **Blocked Paths**: Common live library locations (auto-detected)
- **Whitelist**: Explicitly permitted paths (e.g., `/home/tom/music`)
- **Read-Only**: Never modifies source files
- **Fast Exit**: Fail immediately on safety violations

#### Metadata Collection
- **File Stats**: size, mtime, permissions via `stat()`
- **Audio Info**: duration, bitrate via `ffprobe`/`mediainfo`
- **Directory Structure**: Recursive traversal with manifest filtering
- **Progress**: Real-time feedback during extraction

#### Manifest Filtering
- **Format**: One directory path per line
- **Comments**: Lines starting with `#` ignored
- **Relative Paths**: Relative to library root
- **Subset Support**: Enables fast iteration on smaller corpora

### Filesystem Faker Behavior

#### Path Resolution
- **Corpus Paths**: Served from `metadata.json`
- **Non-Corpus Paths**: Fallback to real filesystem
- **Determinism**: Same metadata → same responses
- **Performance**: Fast lookup via indexed data structure

#### API Compatibility
- **os.path.exists()**: Returns bool based on metadata
- **os.listdir()**: Returns directory contents from metadata
- **os.stat()**: Returns stat_result with metadata values
- **os.path.getsize()**: Returns size from metadata

#### Directory Traversal
- **Recursive**: Supports `os.walk()` style operations
- **Filtering**: Only returns files present in metadata
- **Ordering**: Deterministic ordering for test stability

### Test Execution Behavior

#### Directory Discovery
- **Scanning**: Finds audio directories using faker
- **Evidence Creation**: Extracts fingerprints/metadata via normal channels
- **Batch Processing**: Groups by directory for efficiency
- **Deterministic Ordering**: Sorted by `dir_id` for stable results

#### Decision Resolution
- **AUTO Mode**: Runs identification, picks best candidate if PROBABLE/CERTAIN
- **JAIL Mode**: Marks directory as jailed, skips processing
- **Specific Release**: Forces particular provider/release combination
- **Missing Decisions**: Gracefully skips directory

#### Snapshot Generation
- **REGEN_REAL_CORPUS=1**: Writes new snapshots
- **Normal Mode**: Compares against committed snapshots
- **Failure**: Detailed diff on mismatches
- **Determinism**: Stable ordering and formatting

### Offline Safety

#### Cache-First Semantics
- **Provider Calls**: Only when cache miss
- **Deterministic Misses**: Same behavior across runs
- **Offline Mode**: Configurable cache-only operation
- **Network Independence**: Tests runnable without internet

#### Rerun Invariants
- **Zero Churn**: Second run produces identical results
- **No Provider Calls**: Cache hits prevent network access
- **State Stability**: Same state/layout/tags across reruns
- **Performance**: Fast validation after initial run

---

## 4. Error Handling

### Extraction Errors
- **Permission Denied**: Clear error with path information
- **Missing Tools**: Graceful fallback (ffprobe/mediainfo optional)
- **Corrupt Files**: Skip with logging, continue extraction
- **Manifest Errors**: Validate format, provide actionable messages

### Faker Errors
- **Missing Metadata**: File not found in corpus
- **Path Resolution**: Fallback to real filesystem
- **Stat Errors**: Appropriate errno values
- **Encoding Issues**: UTF-8 handling for international paths

### Test Errors
- **Snapshot Mismatches**: Detailed diff output
- **Provider Failures**: Graceful degradation
- **Cache Corruption**: Fallback to uncached operation
- **Timeout Issues**: Configurable timeouts with fallbacks

### Decision Errors
- **Invalid Format**: Skip with logging
- **Missing Releases**: Skip directory with logging
- **Provider Mismatch**: Validate provider availability
- **Malformed JSON**: Graceful parsing with fallbacks

---

## 5. Performance Characteristics

### Extraction Performance
- **Speed**: ~1000 files/minute (depends on audio analysis)
- **Memory**: Bounded by directory depth
- **Disk I/O**: Read-only, minimal impact
- **Parallelization**: Single-threaded (sequential extraction)

### Test Execution Performance
- **Setup**: < 5 seconds (metadata loading, temp dirs)
- **Scanning**: Linear with directory count
- **Processing**: < 30 seconds per directory (with caching)
- **Snapshot I/O**: < 2 seconds for typical corpus

### Memory Usage
- **Extraction**: ~50MB for large libraries
- **Testing**: ~100MB peak (faker + provider caches)
- **Caching**: Configurable cache sizes
- **No Leaks**: Proper cleanup in test fixtures

### Scalability
- **Small Corpus**: 10-50 albums for development
- **Large Corpus**: 1000+ albums for comprehensive validation
- **Subset Testing**: Manifest-based filtering for fast iteration
- **CI Compatibility**: Opt-in, skipped by default

---

## 6. Compatibility

### Python Version Support
- **Python 3.10+**: Same as V3
- **Dependencies**: Adds `pytest` for test execution
- **Platform**: Linux primary, macOS/Windows compatible

### Corpus Format Compatibility
- **V3.1 Specific**: New metadata format
- **Migration**: Extract fresh corpora from libraries
- **Version Pinning**: Corpus snapshots tied to Resonance version

### Provider Compatibility
- **V3 Providers**: All supported (AcoustID, MusicBrainz, Discogs)
- **Caching**: V3 cache format preserved
- **Offline Mode**: New offline semantics

---

## 7. Testing and Quality

### Test Coverage
- **Real-World Validation**: Exercises V3 against real data
- **Edge Cases**: Legacy tags, deep paths, mixed formats
- **Regression Protection**: Snapshots prevent silent degradation
- **Performance Validation**: Realistic scale testing

### Quality Gates
- **V3 Gates**: All preserved (linting, typing, coverage)
- **New Gates**: Corpus extraction safety, faker transparency
- **CI Integration**: Opt-in corpus testing
- **Audit Compliance**: Full GOVERNANCE.md adherence

### Corpus Quality
- **Diversity**: Multiple genres, eras, tagging styles
- **Realism**: Actual provider responses and cache states
- **Maintainability**: Easy corpus updates and regeneration
- **Privacy**: Metadata-only, no audio content

---

## 8. Limitations and Future Work

### V3.1 Scope Limitations
- Single corpus per test run
- Manifest-based subsetting (no automatic sampling)
- Provider cache sharing with V3
- No corpus compression/optimization
- Manual decision file creation

### Future Extensions
- Multi-corpus support
- Automatic corpus sampling
- Corpus compression for storage
- LLM-assisted decision generation
- Performance benchmarking integration

---

## 9. Migration and Compatibility

### From V3
- **Breaking Changes**: None (additive feature)
- **New Dependencies**: None required for core functionality
- **Test Impact**: New opt-in tests
- **CI Impact**: No changes (corpus tests opt-in)

### Corpus Management
- **Fresh Extraction**: Required for new installations
- **Snapshot Updates**: Via `REGEN_REAL_CORPUS=1`
- **Version Compatibility**: Corpus format tied to Resonance version
- **Sharing**: Corpus snapshots committable to repository

---

## 10. Implementation Notes

### Architecture Invariants
- Faker is transparent to Resonance core
- Decisions are test-only, not production
- Extraction is read-only and safe
- Snapshots follow V3 golden format

### Code Quality
- Comprehensive error handling
- Clear logging and progress reporting
- Type hints throughout
- Test coverage for all new code

### Governance Compliance
- All V3.1 requirements satisfied
- Audit trail complete (AUDIT_V3.1.md)
- No critical-path placeholders
- Formal version closure process

---

*This specification reflects the final, closed state of V3.1 as of 2025-12-23.
V3.1 proves Resonance's real-world reliability at scale.*
